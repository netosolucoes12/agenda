<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MKBAgenda - Personalizado</title>
  <style>
    :root { --pink: #ff40b5; --bg: #050505; --card: #121212; --text: #fff; --border: rgba(255,255,255,0.1); }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); }
    .screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
    .active-screen { display: flex; }
    .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--border); width: 100%; max-width: 500px; margin: auto; }
    .btn-main { width: 100%; padding: 15px; background: var(--pink); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .btn-sec { width: 100%; padding: 10px; background: transparent; color: #fff; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; margin-top: 5px; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #000; color: #fff; margin-top: 8px; }
    
    .day-config { display: flex; align-items: center; gap: 10px; margin-top: 10px; background: #1a1a1a; padding: 10px; border-radius: 8px; }
    .day-config label { flex: 1; font-size: 13px; }
    .day-config input[type="time"] { width: 80px; padding: 5px; font-size: 12px; }

    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #1a1a1a; border-radius: 5px; cursor: pointer; font-size: 12px; }
    .day.selected { background: var(--pink); color: #000; font-weight: bold; }
    .day.off { opacity: 0.1; cursor: default; }
  </style>
</head>
<body>

<div id="screenWelcome" class="screen active-screen">
    <h1 style="color: var(--pink);">MKBAgenda</h1>
    <div class="card">
        <button class="btn-main" onclick="openScreen('screenLogin')">Painel do Profissional</button>
        <button class="btn-sec" onclick="openScreen('screenCliente')">Sou Cliente</button>
    </div>
</div>

<div id="screenLogin" class="screen">
    <div class="card" id="boxLogin">
        <h2>Login</h2>
        <input type="email" id="lEmail" placeholder="E-mail">
        <input type="password" id="lPass" placeholder="Senha">
        <button class="btn-main" onclick="handleLogin()">Entrar</button>
        <button class="btn-sec" onclick="toggleAuth(true)">Criar Conta</button>
        <button class="btn-sec" onclick="openScreen('screenWelcome')">Voltar</button>
    </div>
    <div class="card" id="boxReg" style="display:none;">
        <h2>Criar Conta</h2>
        <input type="text" id="rName" placeholder="Nome do Negócio">
        <input type="email" id="rEmail" placeholder="E-mail">
        <input type="text" id="rZap" placeholder="WhatsApp (Ex: 5511999999999)">
        <input type="password" id="rPass" placeholder="Senha">
        <button class="btn-main" onclick="handleRegister()">Cadastrar</button>
        <button class="btn-sec" onclick="toggleAuth(false)">Voltar</button>
    </div>
</div>

<div id="screenDash" class="screen" style="justify-content: flex-start;">
    <div class="card" style="margin-top:20px;">
        <h2 id="profTitle">Painel</h2>
        <p style="font-size:14px; color:var(--pink);">Configure seus horários:</p>
        <div id="configDiasList"></div>
        <button class="btn-main" onclick="generateLink()">Gerar Link de Agendamento</button>
        <input id="finalLink" readonly style="display:none; font-size:10px; color:var(--pink); margin-top:10px; cursor:pointer;" onclick="copiarLink()">
        <button class="btn-sec" onclick="logout()" style="color:red; margin-top:20px;">Sair</button>
    </div>
</div>

<div id="screenCliente" class="screen" style="justify-content: flex-start;">
    <div class="card" style="margin-top:20px;">
        <h2 id="cliTitle">Agendamento</h2>
        <div id="cliStep1">
            <p>Selecione o dia:</p>
            <div class="cal-grid" id="cal"></div>
        </div>
        <div id="cliStep2" style="display:none;">
            <p>Horários para <span id="diaNomeLabel"></span>:</p>
            <select id="cliHora"></select>
            <button class="btn-main" onclick="setStep(3)">Continuar</button>
            <button class="btn-sec" onclick="setStep(1)">Voltar</button>
        </div>
        <div id="cliStep3" style="display:none;">
            <input id="cNome" placeholder="Seu Nome">
            <textarea id="cServico" placeholder="Qual o atendimento que deseja?"></textarea>
            <button class="btn-main" onclick="finalizarCliente()">Enviar para o WhatsApp</button>
            <button class="btn-sec" onclick="setStep(2)">Voltar</button>
        </div>
    </div>
</div>

<script>
let users = JSON.parse(localStorage.getItem('mkb_users')) || [];
const diasSemana = ["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"];
let agendaDados = null;
let dataSel = "";

const configList = document.getElementById('configDiasList');
diasSemana.forEach(dia => {
    configList.innerHTML += `
        <div class="day-config">
            <input type="checkbox" id="check_${dia}" checked>
            <label>${dia}</label>
            <input type="time" id="in_${dia}" value="08:00">
            <span>até</span>
            <input type="time" id="out_${dia}" value="18:00">
        </div>`;
});

window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    if(params.has('data')) {
        try {
            agendaDados = JSON.parse(decodeURIComponent(params.get('data')));
            openScreen('screenCliente');
            initCliente();
        } catch(e) { console.error("Erro ao carregar dados"); }
    } else if(localStorage.getItem('logged_user')) {
        loadDash();
    }
};

function openScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
    document.getElementById(id).classList.add('active-screen');
}

function toggleAuth(reg) {
    document.getElementById('boxLogin').style.display = reg ? 'none' : 'block';
    document.getElementById('boxReg').style.display = reg ? 'block' : 'none';
}

function handleRegister() {
    const n = document.getElementById('rName').value, e = document.getElementById('rEmail').value.toLowerCase(), 
          z = document.getElementById('rZap').value, p = document.getElementById('rPass').value;
    if(!n || !e || !z || p.length < 6) return alert("Preencha tudo corretamente!");
    users.push({name: n, email: e, zap: z, pass: p});
    localStorage.setItem('mkb_users', JSON.stringify(users));
    alert("Conta criada!"); toggleAuth(false);
}

function handleLogin() {
    const e = document.getElementById('lEmail').value.toLowerCase(), p = document.getElementById('lPass').value;
    const user = users.find(u => u.email === e && u.pass === p);
    if(user) { localStorage.setItem('logged_user', e); loadDash(); } else alert("Erro de login!");
}

function loadDash() {
    const user = users.find(u => u.email === localStorage.getItem('logged_user'));
    document.getElementById('profTitle').textContent = user.name;
    openScreen('screenDash');
}

function generateLink() {
    const user = users.find(u => u.email === localStorage.getItem('logged_user'));
    let configHorarios = {};
    diasSemana.forEach(dia => {
        if(document.getElementById(`check_${dia}`).checked) {
            configHorarios[dia] = {
                in: document.getElementById(`in_${dia}`).value,
                out: document.getElementById(`out_${dia}`).value
            };
        }
    });

    const dataObj = { nome: user.name, zap: user.zap, horarios: configHorarios };
    const jsonStr = encodeURIComponent(JSON.stringify(dataObj));
    const linkBase = window.location.href.split('?')[0];
    const linkFinal = `${linkBase}?data=${jsonStr}`;
    
    const inp = document.getElementById('finalLink');
    inp.value = linkFinal;
    inp.style.display = 'block';
    alert("Link Gerado!");
}

function copiarLink() {
    const inp = document.getElementById('finalLink');
    inp.select();
    document.execCommand('copy');
    alert("Copiado!");
}

function initCliente() {
    document.getElementById('cliTitle').textContent = agendaDados.nome;
    const cal = document.getElementById('cal');
    cal.innerHTML = "";
    const hoje = new Date();
    for(let i=1; i<=31; i++) {
        const d = document.createElement('div'); d.className = 'day'; d.textContent = i;
        const dataObjeto = new Date(hoje.getFullYear(), hoje.getMonth(), i);
        const nomeDia = diasSemana[dataObjeto.getDay()];
        if(!agendaDados.horarios[nomeDia]) { d.classList.add('off'); }
        else {
            d.onclick = () => { 
                dataSel = i + "/" + (hoje.getMonth() + 1);
                document.getElementById('diaNomeLabel').textContent = nomeDia;
                carregarHoras(nomeDia); setStep(2); 
            };
        }
        cal.appendChild(d);
    }
}

function carregarHoras(diaNome) {
    const sel = document.getElementById('cliHora'); sel.innerHTML = "";
    const hIn = parseInt(agendaDados.horarios[diaNome].in);
    const hOut = parseInt(agendaDados.horarios[diaNome].out);
    for(let h=hIn; h<hOut; h++) {
        sel.innerHTML += `<option value="${h}:00">${h}:00</option><option value="${h}:30">${h}:30</option>`;
    }
}

function setStep(n) {
    [1,2,3].forEach(s => document.getElementById('cliStep'+s).style.display = 'none');
    document.getElementById('cliStep'+n).style.display = 'block';
}

function finalizarCliente() {
    const nome = document.getElementById('cNome').value;
    const servico = document.getElementById('cServico').value;
    if(!nome || !servico) return alert("Preencha nome e serviço!");
    const msg = `Olá ${agendaDados.nome}! Agendamento:\nServiço: ${servico}\nData: ${dataSel}\nHora: ${document.getElementById('cliHora').value}\nNome: ${nome}`;
    window.location.href = `https://wa.me/${agendaDados.zap}?text=${encodeURIComponent(msg)}`;
}

function logout() { localStorage.removeItem('logged_user'); location.reload(); }
</script>
</body>
</html>
